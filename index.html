<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3599 왕국 전쟁 통계</title>
  <style>
    :root {
      --bg1: rgba(18,18,18,0.9);
      --bg2: rgba(34,34,34,0.9);
      --card: rgba(30,30,30,0.4);
      --gold: #D4AF37;
      --text: #EEE;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      padding: 20px;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      font-family: Arial, sans-serif;
      text-align: center;
      min-height: 100vh;
    }
    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2.8rem;
      color: var(--gold);
      margin-bottom: 20px;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
    }
    #langToggle {
      position: absolute; top:20px; right:20px;
      background: var(--gold); color: #121212; border: none;
      padding: 8px 12px; border-radius: 4px; font-weight: bold;
      cursor: pointer; transition: transform .2s;
    }
    #langToggle:hover { transform: translateY(-2px); }
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .tab-btn {
      padding: 8px 16px;
      background: var(--card);
      border: none; border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      transition: transform .2s, background .2s;
    }
    .tab-btn:hover { transform: translateY(-2px); }
    .tab-btn.active {
      background: var(--gold); color: #121212;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .card {
      background: var(--card); backdrop-filter: blur(6px);
      margin: 0 auto 20px; padding: 15px; width: 300px;
      border-radius: 8px; box-shadow: 2px 2px 12px rgba(0,0,0,0.6);
    }
    .card strong { display: block; margin-bottom: 8px; }
    .btn {
      display: inline-block;
      background: #7289DA; color: #fff;
      text-decoration: none; padding: 8px 16px;
      border-radius: 4px; margin-bottom: 20px;
      cursor: pointer; transition: transform .2s;
    }
    .btn:hover { transform: translateY(-2px); }
    .search-box {
      margin: 10px auto; max-width: 400px; display: block;
      padding: 8px; width: 100%; border-radius: 4px;
      border: 1px solid #555; background: var(--card);
      color: var(--text);
    }
    .member-section, .pagination { display: none; }
    .member-section.active, .pagination.active { display: block; }
    .member-section {
      max-width: 800px; margin: 20px auto; text-align: left;
    }
    .member-section h2 {
      font-family:'Cinzel', serif;
      color: var(--gold); margin-bottom: 10px;
    }
    table {
      width: 100%; border-collapse: collapse;
      background: var(--card); margin-top: 10px;
    }
    th, td { border: 1px solid #444; padding: 8px; }
    th { background: #2A2A2A; }
    tr:nth-child(even) { background: rgba(30,30,30,0.3); }
    .page-controls { text-align: center; margin: 10px 0; }
    .page-size { margin-left: 10px; padding: 4px; }
    .page-btn {
      margin: 0 4px; padding: 4px 8px; border: none;
      background: var(--card); color: var(--text);
      border-radius: 4px; cursor: pointer;
    }
    .page-btn.active { background: var(--gold); color: #121212; }
    .page-btn:hover { background: var(--gold); color: #121212; }
  </style>
</head>
<body>
  <button id="langToggle">EN</button>
  <h1 id="title">3599 왕국 전쟁 통계</h1>

  <div class="tabs">
    <button class="tab-btn active" data-key="sheet1">KVK 1</button>
    <button class="tab-btn"        data-key="sheet2">KVK 2</button>
    <button class="tab-btn"        data-key="sheet3">KVK 3</button>
  </div>

  <div class="card">
    <strong id="totalKPLabel">총 KP (모든 참여자)</strong>
    <p id="totalKP">로딩 중...</p>
  </div>

  <a id="discordBtn" class="btn" href="https://discord.gg/bt9grH4U3w" target="_blank">Discord 초대</a>

  <input type="text" id="searchInput" class="search-box" placeholder="멤버 이름 또는 ID 검색…" />

  <div class="page-controls">
    표시 수:
    <select id="pageSizeSelect" class="page-size">
      <option>10</option><option>20</option><option>50</option>
    </select>
  </div>

  <!-- Sections -->
  <div class="member-section active" id="section-sheet1"></div>
  <div class="pagination active"     id="pages-sheet1"></div>
  <div class="member-section"        id="section-sheet2"></div>
  <div class="pagination"           id="pages-sheet2"></div>
  <div class="member-section"        id="section-sheet3"></div>
  <div class="pagination"           id="pages-sheet3"></div>

  <script>
    const sheetNames = { sheet1:'시트 1', sheet2:'시트 2', sheet3:'시트 3' };
    const texts = {
      ko: { title:'3599 왕국 전쟁 통계', totalKP:'총 KP (모든 참여자)', discord:'Discord 초대', headers12:['ID','멤버','총 KP'], headers3:['ID','멤버','목표 DKP','현재 DKP','총 KP','전사자'] },
      en: { title:'3599 Kingdom War Stats', totalKP:'Total KP (All Participants)', discord:'Invite Discord', headers12:['ID','Member','Total KP'], headers3:['ID','Member','Goal DKP','Current DKP','Total KP','Casualties'] }
    };
    let lang='ko';

    const sheetId='1G2RwOq32kSubrYRtO5xt6UsaIXQBdfjKsz9r386PFso';
    const keys=['sheet1','sheet2','sheet3'];
    const dataBySheet={}, pageSize={}, currentPage={};

    // Toggle language
    document.getElementById('langToggle').onclick = ()=>{ lang = lang==='ko'?'en':'ko'; applyLang(); };
    // Change page size
    document.getElementById('pageSizeSelect').onchange = e=> {
      keys.forEach(k=>{ pageSize[k]=+e.target.value; currentPage[k]=1; renderTable(k); });
    };
    // Search filter
    document.getElementById('searchInput').oninput = ()=> keys.forEach(renderTable);

    // Fetch from Google Sheets
    async function fetchAll(key){
      const sheet = sheetNames[key];
      const res = await fetch(
        `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?`+
        `tqx=out:json&sheet=${encodeURIComponent(sheet)}`
      );
      const txt = await res.text();
      const json = JSON.parse(txt.substr(47).slice(0,-2));
      const rows = json.table.rows.map(r=>r.c.map(c=>c?.v||''));
      if(key==='sheet3'){
        return rows.map(r=>({ id:r[0], name:r[1], goalDKP:+r[2]||0, currentDKP:+r[3]||0, totalKP:+r[4]||0, casualties:+r[5]||0 }));
      } else {
        return rows.map(r=>({ id:r[1], name:r[2], totalKP:+r[3]||0 }));
      }
    }

    // Init
    (async()=>{
      let grandTotal=0;
      for(const k of keys){
        let data = await fetchAll(k);
        data = data.sort((a,b)=>(b.totalKP||0)-(a.totalKP||0)).slice(0,200);
        dataBySheet[k]=data;
        grandTotal += data.reduce((s,m)=>s+(m.totalKP||0),0);
        pageSize[k]=10; currentPage[k]=1;
      }
      document.getElementById('totalKP').textContent = grandTotal.toLocaleString();
      keys.forEach(renderTable);
      setupTabs(); applyLang();
    })();

    function renderTable(key){
      const data = dataBySheet[key];
      const q = document.getElementById('searchInput').value.toLowerCase();
      const filt = data.filter(m => m.name.toLowerCase().includes(q) || m.id.toString().includes(q));
      const ps = pageSize[key];
      const tp = Math.max(Math.ceil(filt.length/ps),1);
      let pg = currentPage[key]; if(pg>tp) pg=1; currentPage[key]=pg;
      const pageData = filt.slice((pg-1)*ps, (pg-1)*ps+ps);

      const sec = document.getElementById(`section-${key}`);
      const hdrs = key==='sheet3'? texts[lang].headers3 : texts[lang].headers12;
      let html = `<h2>${sheetNames[key].replace('시트','KVK')}</h2><table><thead><tr>`;
      hdrs.forEach(h=> html+=`<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      pageData.forEach(m=>{
        html += '<tr>' +
          `<td>${m.id}</td><td>${m.name}</td>`+
          (key==='sheet3'
            ? `<td>${m.goalDKP.toLocaleString()}</td><td>${m.currentDKP.toLocaleString()}</td>`
            : '') +
          `<td>${m.totalKP.toLocaleString()}</td>` +
          (key==='sheet3' ? `<td>${m.casualties.toLocaleString()}</td>` : '') +
          '</tr>';
      });
      html += '</tbody></table>';
      sec.innerHTML = html;

      const pag = document.getElementById(`pages-${key}`);
      pag.innerHTML = Array.from({length:tp},(_,i)=>
        `<button class="page-btn${i+1===pg?' active':''}" data-key="${key}" data-page="${i+1}">${i+1}</button>`
      ).join('');
      pag.querySelectorAll('.page-btn').forEach(btn=>{
        btn.onclick = ()=>{ currentPage[key] = +btn.dataset.page; renderTable(key);} ;
      });
    }

    function setupTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.onclick = ()=>{
          document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
          document.querySelectorAll('.member-section, .pagination').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active');
          const key = btn.dataset.key;
          document.getElementById(`section-${key}`).classList.add('active');
          document.getElementById(`pages-${key}`).classList.add('active');
        };
      });
    }

    function applyLang(){
      const t = texts[lang];
      document.getElementById('title').textContent = t.title;
      document.getElementById('totalKPLabel').textContent = t.totalKP;
      document.getElementById('discordBtn').textContent = t.discord;
      document.getElementById('searchInput').placeholder =
        lang==='ko' ? '멤버 이름 또는 ID 검색…' : 'Search by name or ID…';
    }
  </script>
</body>
</html>
